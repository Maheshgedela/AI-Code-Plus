<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Mentor | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; }
        .navbar { background-color: #2d3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s; }
        .btn-primary { background-color: #4e73df; border: none; border-radius: 8px; padding: 10px 20px; }
        .status-badge { font-size: 0.75rem; font-weight: 600; padding: 5px 12px; border-radius: 20px; text-transform: uppercase; color: white !important; }
        .code-area { font-family: 'Fira Code', monospace; background-color: #1e1e1e; color: #dcdcdc; border-radius: 10px; padding: 18px; width: 100%; height: 280px; resize: none; border: 2px solid #333; outline: none; }
        .ai-output { background-color: #ffffff; border-left: 5px solid #4e73df; padding: 20px; border-radius: 8px; display: none; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        #aiContent { white-space: pre-wrap; line-height: 1.7; font-size: 0.95rem; color: #2c3e50; }
        .score-badge { background: #f39c12; color: white; padding: 5px 15px; border-radius: 50px; font-weight: bold; cursor: pointer; }

        /* Notification Specific CSS */
        .notification-bell { position: relative; cursor: pointer; font-size: 1.4rem; color: white; margin-right: 20px; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 50%; }
        .notif-item { border-bottom: 1px solid #eee; padding: 10px; transition: background 0.3s; }
        .notif-item:hover { background: #f8f9fa; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1"><i class="bi bi-robot me-2"></i> AI Code Mentor</span>
        <div class="d-flex align-items-center">
            <div class="notification-bell" onclick="loadNotifications()">
                <i class="bi bi-bell-fill"></i>
                <span id="notifCount" class="notif-badge">0</span>
            </div>

            <button class="btn btn-outline-info btn-sm fw-bold me-2 px-3" onclick="loadMyHistory()">
                <i class="bi bi-clock-history me-1"></i> My History
            </button>
            <span class="score-badge me-3" onclick="loadLeaderboard()">
                <i class="bi bi-trophy-fill me-1"></i> <span id="userScoreDisplay">0</span> Points
            </span>
            <button class="btn btn-outline-light btn-sm fw-bold" onclick="loadLeaderboard()">Leaderboard</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-4">
            <div class="card p-4 mb-4 shadow-sm">
                <h5 class="mb-3 text-primary"><i class="bi bi-person-circle me-1"></i> Student Profile</h5>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">ACTIVE USERNAME</label>
                    <input type="text" id="usernameInput" class="form-control fw-bold border-primary shadow-none" value="Ganesh" onchange="refreshAll()">
                    <p class="small text-muted mt-1">History and score will be tracked for this user.</p>
                </div>
                <hr>
                <h5 class="mb-3 text-primary"><i class="bi bi-plus-circle me-1"></i> Post New Problem</h5>
                <form th:action="@{/ui/add}" method="post">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Title</label>
                        <input type="text" name="title" class="form-control" placeholder="e.g. Find Max" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Difficulty</label>
                        <select name="difficulty" class="form-select">
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Description</label>
                        <textarea name="description" class="form-control" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold">Add Problem</button>
                </form>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card p-3 mb-4 border-start border-primary border-4 shadow-sm">
                <form th:action="@{/ui/dashboard}" method="get" class="d-flex">
                    <input type="text" name="search" th:value="${searchWord}" class="form-control me-2 border-0 shadow-none" placeholder="Search problems...">
                    <button type="submit" class="btn btn-primary px-4"><i class="bi bi-search"></i></button>
                </form>
            </div>
            <div class="card p-4 shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light text-uppercase small">
                        <tr><th>Challenge Name</th><th>Level</th><th>Action</th></tr>
                        </thead>
                        <tbody>
                        <tr th:each="p : ${problems}">
                            <td>
                                <div class="fw-bold" th:text="${p.title}"></div>
                                <div class="small text-muted" th:text="${#strings.abbreviate(p.description, 50)}"></div>
                            </td>
                            <td><span th:classappend="${p.difficulty == 'Hard' ? 'bg-danger' : (p.difficulty == 'Medium' ? 'bg-warning text-dark' : 'bg-success')}" class="status-badge badge" th:text="${p.difficulty ?: 'Easy'}"></span></td>
                            <td><button type="button" class="btn btn-sm btn-outline-primary fw-bold px-3" th:data-id="${p.id}" th:data-title="${p.title}" onclick="openSolveModal(this)">Solve</button></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="notificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-bell me-2"></i> Recent Notifications</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="notificationList" style="max-height: 400px; overflow-y: auto;">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="leaderboardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">üèÜ Global Leaderboard</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-light"><tr><th class="ps-4">Rank</th><th>User</th><th class="pe-4 text-end">Score</th></tr></thead>
                    <tbody id="leaderboardRows"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-clock-history me-1"></i> My Submissions</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                        <tr><th>Time</th><th>Status</th><th>AI Feedback</th></tr>
                        </thead>
                        <tbody id="historyRows"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="solveModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="modalTitle">Solve Problem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <textarea id="userCode" class="code-area" placeholder="Write your Java code here..."></textarea>
                <div id="aiResponse" class="ai-output">
                    <h6 class="text-primary fw-bold mb-3"><i class="bi bi-stars me-2"></i> AI Mentor Result:</h6>
                    <p id="aiContent" class="mb-0"></p>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <div id="loader" class="spinner-border spinner-border-sm text-primary d-none me-2"></div>
                <button type="button" class="btn btn-primary px-5 fw-bold" onclick="askAI()">Submit Solution</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let activeId = null;
    const GATEWAY_URL = "http://localhost:8081";

    window.onload = refreshAll;

    function refreshAll() {
        refreshUserScore();
        updateNotificationBadge();
    }

    async function refreshUserScore() {
        const username = document.getElementById('usernameInput').value;
        if(!username) return;
        try {
            const res = await fetch(`${GATEWAY_URL}/api/users/${username}`);
            if(res.ok) {
                const user = await res.json();
                document.getElementById('userScoreDisplay').innerText = user.score;
            }
        } catch (e) { console.error("Score refresh failed"); }
    }

    // NEW: Update Bell Badge Count
    async function updateNotificationBadge() {
        const username = document.getElementById('usernameInput').value;
        try {
            const res = await fetch(`${GATEWAY_URL}/api/notifications/${username}`);
            const data = await res.json();
            document.getElementById('notifCount').innerText = data.length;
        } catch (e) { console.log("Notif badge fail"); }
    }

    // NEW: Load Notifications into Modal
    async function loadNotifications() {
        const username = document.getElementById('usernameInput').value;
        const list = document.getElementById('notificationList');
        list.innerHTML = '<p class="p-3 text-center">Loading notifications...</p>';
        new bootstrap.Modal(document.getElementById('notificationModal')).show();

        try {
            const res = await fetch(`${GATEWAY_URL}/api/notifications/${username}`);
            const data = await res.json();
            list.innerHTML = "";
            if(data.length === 0) {
                list.innerHTML = '<p class="p-4 text-center text-muted">No notifications yet.</p>';
                return;
            }
            data.forEach(n => {
                list.innerHTML += `
                    <div class="notif-item">
                        <div class="small fw-bold text-primary">${n.type}</div>
                        <div class="small text-dark">${n.message}</div>
                        <div class="text-muted" style="font-size: 0.7rem;">${new Date(n.createdAt).toLocaleString()}</div>
                    </div>`;
            });
        } catch (e) { list.innerHTML = '<p class="p-3 text-danger">Failed to load.</p>'; }
    }

    // Modified askAI to update notifications
    async function askAI() {
        const code = document.getElementById('userCode').value;
        const loader = document.getElementById('loader');
        const outputBox = document.getElementById('aiResponse');
        const content = document.getElementById('aiContent');
        const username = document.getElementById('usernameInput').value;

        if(!code.trim()) { alert("Write code first!"); return; }

        loader.classList.remove('d-none');
        outputBox.style.display = 'block';
        content.innerText = "AI is thinking...";

        try {
            const aiRes = await fetch(`${GATEWAY_URL}/api/problems/${activeId}/explain`, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: code
            });
            const aiText = await aiRes.text();
            content.innerText = aiText;

            const status = aiText.includes("STATUS: Correct") ? "Correct" : "Incorrect";

            const submissionPayload = {
                username: username,
                problemId: activeId,
                code: code,
                status: status,
                aiFeedback: aiText
            };

            await fetch(`${GATEWAY_URL}/api/submissions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(submissionPayload)
            });

            // UI Refresh
            refreshUserScore();
            updateNotificationBadge(); // Automatic badge update after submission

            if(status === "Correct") {
                alert("üéâ Correct Answer! Notification Sent.");
            }

        } catch (e) { content.innerText = "Error: Service unavailable."; }
        finally { loader.classList.add('d-none'); }
    }

    // Other functions (Leaderboard, History) same as your original code
    async function loadLeaderboard() {
        const rows = document.getElementById('leaderboardRows');
        rows.innerHTML = '<tr><td colspan="3" class="text-center p-4">Loading stats...</td></tr>';
        new bootstrap.Modal(document.getElementById('leaderboardModal')).show();

        try {
            const res = await fetch(`${GATEWAY_URL}/api/users`);
            const users = await res.json();
            rows.innerHTML = "";
            users.forEach((u, i) => {
                rows.innerHTML += `
                    <tr>
                        <td class="ps-4 text-muted">#${i+1}</td>
                        <td class="fw-bold text-dark">${u.username}</td>
                        <td class="pe-4 text-end"><span class="badge bg-success">${u.score}</span></td>
                    </tr>`;
            });
        } catch (e) { rows.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading leaderboard</td></tr>'; }
    }

    async function loadMyHistory() {
        const username = document.getElementById('usernameInput').value;
        const rows = document.getElementById('historyRows');
        rows.innerHTML = '<tr><td colspan="3" class="text-center p-4">Fetching your history...</td></tr>';
        new bootstrap.Modal(document.getElementById('historyModal')).show();

        try {
            const res = await fetch(`${GATEWAY_URL}/api/submissions/user/${username}`);
            const data = await res.json();
            rows.innerHTML = "";
            data.forEach(h => {
                const time = new Date(h.submittedAt).toLocaleString();
                rows.innerHTML += `
                    <tr>
                        <td class="small text-muted">${time}</td>
                        <td><span class="badge ${h.status === 'Correct' ? 'bg-success' : 'bg-danger'}">${h.status}</span></td>
                        <td class="small text-truncate" style="max-width: 300px;">${h.aiFeedback}</td>
                    </tr>`;
            });
        } catch (e) { rows.innerHTML = '<tr><td colspan="3" class="text-center">No history found.</td></tr>'; }
    }

    function openSolveModal(btn) {
        activeId = btn.getAttribute('data-id');
        document.getElementById('modalTitle').innerText = "Challenge: " + btn.getAttribute('data-title');
        document.getElementById('userCode').value = "";
        document.getElementById('aiResponse').style.display = 'none';
        new bootstrap.Modal(document.getElementById('solveModal')).show();
    }
</script>
</body>
</html>